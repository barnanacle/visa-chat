name: Deploy to Cafe24

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: Checkout code
      uses: actions/checkout@v4
      
    # 2. Node.js ì„¤ì •
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    # 3. ì˜ì¡´ì„± ì„¤ì¹˜
    - name: Install dependencies
      run: npm install
      
    # 4. ì„œë²„ ê¶Œí•œ ì¤€ë¹„ (FTP ì—…ë¡œë“œ ì „)
    - name: Prepare server permissions
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.CAFE24_SSH_HOST }}
        username: ${{ secrets.CAFE24_SSH_USERNAME }}
        key: ${{ secrets.CAFE24_SSH_KEY }}
        script: |
          echo "ğŸ”§ ì„œë²„ ê¶Œí•œ ì¤€ë¹„ ì¤‘..."
          
          # ë””ë ‰í† ë¦¬ê°€ ì—†ìœ¼ë©´ ìƒì„±
          mkdir -p /var/www/html/visachat
          
          # FTP ì‚¬ìš©ìë¥¼ www-data ê·¸ë£¹ì— ì¶”ê°€
          usermod -a -G www-data ftpuser 2>/dev/null || true
          
          # ë””ë ‰í† ë¦¬ ê¶Œí•œ ì„¤ì •
          chown -R www-data:www-data /var/www/html/visachat
          chmod -R 775 /var/www/html/visachat
          
          echo "âœ… ì„œë²„ ê¶Œí•œ ì„¤ì • ì™„ë£Œ"
        port: 22
        timeout: 30s
        command_timeout: 2m
      
    # 5. FTPë¡œ íŒŒì¼ ì—…ë¡œë“œ
    - name: Deploy to Cafe24 via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.CAFE24_FTP_HOST }}
        username: ${{ secrets.CAFE24_FTP_USERNAME }}
        password: ${{ secrets.CAFE24_FTP_PASSWORD }}
        server-dir: '/var/www/html/visachat/'
        log-level: verbose
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/.env
          **/.env.*
          **/README.md
          **/.gitignore
          **/.github/**
          **/test-results/**
          **/coverage/**
          **/*.log
          **/.DS_Store
          **/Thumbs.db
          **/backup/**
          **/VISACHAT_DEPLOYMENT_TEMPLATE.md
          **/source_data/**
          **/scripts/**
          **/.pdf-hash
          **/documents/**
          
    # 6. FTP ì—…ë¡œë“œ í›„ ê¶Œí•œ ìˆ˜ì •
    - name: Fix permissions after FTP upload
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.CAFE24_SSH_HOST }}
        username: ${{ secrets.CAFE24_SSH_USERNAME }}
        key: ${{ secrets.CAFE24_SSH_KEY }}
        script: |
          cd /var/www/html/visachat
          echo "ğŸ”§ FTP ì—…ë¡œë“œ í›„ ê¶Œí•œ ìˆ˜ì • ì¤‘..."
          
          chown -R www-data:www-data /var/www/html/visachat
          chmod -R 775 /var/www/html/visachat
          
          echo "ğŸ“ ì—…ë¡œë“œëœ íŒŒì¼ë“¤:"
          ls -la
          
          echo "âœ… ê¶Œí•œ ìˆ˜ì • ì™„ë£Œ"
        port: 22
        timeout: 30s
        command_timeout: 2m
          
    # 7. ì„œë²„ ì¬ì‹œì‘
    - name: Restart Server after Deploy
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.CAFE24_SSH_HOST }}
        username: ${{ secrets.CAFE24_SSH_USERNAME }}
        key: ${{ secrets.CAFE24_SSH_KEY }}
        script: |
          cd /var/www/html/visachat
          echo "ğŸ“ í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
          
          echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
          npm install --production
          
          echo "ğŸ”„ PM2 í”„ë¡œì„¸ìŠ¤ ìƒíƒœ í™•ì¸:"
          pm2 list
          
          # PM2 í”„ë¡œì„¸ìŠ¤ê°€ ì¡´ì¬í•˜ë©´ ì¬ì‹œì‘, ì—†ìœ¼ë©´ ìƒˆë¡œ ì‹œì‘
          if pm2 describe visachat > /dev/null 2>&1; then
            echo "ğŸ”„ visachat ì„œë²„ ì¬ì‹œì‘ ì¤‘..."
            pm2 restart visachat
          else
            echo "ğŸš€ visachat ì„œë²„ ìƒˆë¡œ ì‹œì‘..."
            pm2 start index.js --name visachat
          fi
          
          sleep 5
          
          echo "ğŸ“Š ìµœì¢… ìƒíƒœ í™•ì¸:"
          pm2 list
          pm2 save
          
          echo "âœ… visachat ì„œë²„ ë°°í¬ ì™„ë£Œ!"
        port: 22
        timeout: 30s
        command_timeout: 5m
